# How to Store Secrets in Environment Variables

New projects **does not use Rails Credentials**. All secrets are stored and read via **environment variables**.

---

## File Policy

- **`.env`** — used **only for local development**. This file is git-ignored and **must not** be committed.
- **`.env.example`** — committed to the repo as a **template** (placeholders only).
- There are **no** other dotenv files: no `.env.development`, `.env.test`, `.env.local`, etc.

> In non-development environments we do not use repo-stored dotenv files.
> - Test: variables are injected via GitLab CI/CD Variables.
> - Staging/Production: variables are supplied by the platform (Kubernetes Secrets, Docker `env_file`/`environment`, or OS-level environment variables), or via a securely managed `.env` file that is provisioned outside the repository.


---

## Loading Behavior

- `dotenv` is included **for all environments**:
  ```ruby
  # Gemfile
  gem 'dotenv'
  ```
- So **`.env`**  file can be use in other environments.

---

## What Goes Where

### `.env` (development; not committed)
```dotenv
SECRET_KEY_BASE=...               # auto-generated by the template
SMTP_USER=some_user
SMTP_PASSWORD=some_password
```

### `.env.example` (committed)
```dotenv
SECRET_KEY_BASE=
SMTP_USER=
SMTP_PASSWORD=
```

---

## Using ENV in the App

### Rails secret key
```ruby
# config/environments/production.rb
config.require_master_key = false
config.secret_key_base = ENV.fetch('SECRET_KEY_BASE')
```

### Test environment (no `.env.test`)
Provide the key via GitLub CI settings, CI settings url example: **`https://git.themindstudios.com/web/project_name/-/settings/ci_cd`**, or set a safe default in test config:

```ruby
# config/environments/test.rb
config.secret_key_base = ENV['SECRET_KEY_BASE'] || 'test_secret_key_only_for_specs'
```

### Integrations (examples)
```ruby
# config/environments/dev.rb
ActionMailer::Base.smtp_settings = {
  user_name: ENV['SMTP_USER'],
  password:  ENV['SMTP_PASSWORD'],
  # ...
}

# config/initializers/sentry.rb
Sentry.init do |config|
  config.dsn = ENV['SENTRY_DSN']
end
```

---

## Adding a New Secret (Team Workflow)

1. **Use it in code** via `ENV['NEW_SECRET']`
2. **Document it**: add `NEW_SECRET=` to `.env.example`.
3. **Local dev**: put the real value in your local `.env`.
4. Notify other developers about changing in `.env` and share a file `.env` in slack.
4. **Test/Dev/Staging/Production**: set the variable in your platform: CI variables, Docker/Compose `env_file`/`environment`, Kubernetes Secret, systemd, etc.

---

## Security Guidelines

- **Never commit real secrets.** `.env` is in `.gitignore`.
- **Always update `.env.example`** when introducing a new variable.
- Use **separate values per environment** (dev/test/staging/prod).
- Avoid printing secrets in logs/CI output.

---

## Common Pitfalls & Fixes

- **“Missing `SECRET_KEY_BASE` in test”** → pass it via CI variables or set a default in `test.rb`.
- **“.env changes aren’t applied”** → restart server/console; dotenv loads on boot.
- **Special characters in values** → wrap in quotes, e.g., `PASSWORD="p@$$ w0rd"`.
- **Multiline secrets (PEM, JWT certs, etc)** → store base64 in ENV and decode at runtime, or mount separate files.

---

## FAQ

**Do we still need `SECRET_KEY_BASE` without credentials?**  
Yes. Rails uses it to sign/verify cookies, CSRF tokens, etc. We source it from ENV.

**One key for all environments?**  
No. Use different values for dev/test/staging/prod if possible.

**Where is the list of required variables?**  
`.env.example`. Keep it up to date whenever a new variable is introduced.
